---
title: "checkpoint2"
output: html_document
---

```{r global_options, include=TRUE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE, fig.width=12, fig.height=6)
```

---

```{r echo=FALSE}
require(ggplot2, quietly = TRUE)
library(ggfortify, quietly = TRUE)
# http://rpubs.com/sinhrks/basics
require(GGally, quietly = TRUE)
require(reshape2, quietly = TRUE)
require(dplyr, quietly = TRUE)
library(knitr, quietly = TRUE)
library(cluster)
library(ggdendro)
library(reshape)
theme_set(theme_bw())
```


Para o checkpoint 2 do problema 3, utilizaremos os dados sobre verbas alocadas por deputados para municípios, estados e fundações através de emendas parlamentares. 

```{r}
detalhes_emendas <- read.csv("emendas_detalhes_parlamentar.csv")
```

Para uma melhor sumarizaçao dos dados, iremos agrupar as emendas por mes e ano, e utilizaremos a coluna 'VALOR_REPASSE_EMENDA' para sumarizar o total repassado do governo federal para a emenda proposta que foi aprovada. 

```{r}
detalhes_emendas <- detalhes_emendas %>%
    filter(!is.na(NOME_PARLAMENTAR), !is.na(DESC_ORGAO_SUP), !is.na(funcao.imputada)) %>%
  arrange(-ANO_PROP, -MES_PROP, DIA_PROP)

#agrupando por mes, ano e funçao imputada
  emendas_ano <- detalhes_emendas %>%
    group_by(funcao.imputada, ANO_PROP, MES_PROP) %>%
    summarise(total.valor.repasse.emenda = sum(VALOR_REPASSE_EMENDA))

# transformando funçoes imputadas em colunas
#assim ao final teremos os gastos em cada funçao por ano e mes
  emendas_ano_cast <- emendas_ano %>%
    cast(ANO_PROP+MES_PROP~funcao.imputada) %>%
    arrange(ANO_PROP,MES_PROP)  
  
# trocando valores Na por 0 
  emendas_ano_cast <- do.call(data.frame,lapply(emendas_ano_cast, function(x) replace(x, is.na(x),0)))

summary(emendas_ano_cast)

```

As variáveis são bastante assimétricas, iremos transformar para log para ajudar na visualizaçao.

```{r}
# Escala de log 
emendas_ano_log <- log(emendas_ano_cast[,3:18])
emendas_ano_log$MES_PROP <- emendas_ano_cast$MES_PROP
emendas_ano_log$ANO_PROP <- emendas_ano_cast$ANO_PROP



emendas_normalizadas <- do.call(data.frame,lapply(emendas_ano_log, function(x) replace(x, is.infinite(x),0)))

```



```{r}
pr.out = prcomp(emendas_normalizadas, scale = TRUE) 

# Porcentagem da variância explicada: 
plot_pve <- function(prout){
  pr.var <- pr.out$sdev^2
  pve <- pr.var / sum(pr.var)
  df = data.frame(x = 1:NROW(pve), y = cumsum(pve))
  ggplot(df, aes(x = x, y = y)) + 
    geom_point(size = 3) + 
    geom_line() + 
    labs(x='Principal Component', y = 'Cumuative Proportion of Variance Explained')
}

plot_pve(pr.out)
```


```{r}

autoplot(pr.out, data = emendas_normalizadas, colour = 'MES_PROP',
         loadings = TRUE, loadings.colour = 'blue',
         loadings.label = TRUE, loadings.label.size = 3,
         label= TRUE, label='ANO_PROP')




autoplot(prcomp(df), data = iris, colour = 'Species', loadings = TRUE)

# autoplot(pr.out, label.size = 3,loadings = TRUE, 
#          loadings.label = TRUE, loadings.label.size = 3,  data = emendas_ano,colour = "ANO_PROP") 


kable(pr.out$rotation)
biplot(pr.out, scale = 0)


autoplot(pr.out, label = TRUE, label.size = 3, shape = FALSE, 
         loadings = TRUE, loadings.colour = 'blue',
         loadings.label = TRUE, loadings.label.size = 3)

# Porcentagem da variância explicada: 
plot_pve <- function(prout){
  pr.var <- pr.out$sdev^2
  pve <- pr.var / sum(pr.var)
  df = data.frame(x = 1:NROW(pve), y = cumsum(pve))
  ggplot(df, aes(x = x, y = y)) + 
    geom_point(size = 3) + 
    geom_line() + 
    labs(x='Principal Component', y = 'Cumuative Proportion of Variance Explained')
}

plot_pve(pr.out)
```
----


