---
title: "Problema 4 - checkpoint 1"
output: html_document
---

```{r global_options, include=TRUE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE, fig.width=12, fig.height=6)
```

 

```{r echo=FALSE}
library(dplyr, warn.conflicts = FALSE)
library(ggplot2)
library(tidyr)
#install.packages("resample")
library(resample)
theme_set(theme_bw())

filmes = read.csv("dados/movies.csv",  encoding="UTF-8")
ratings = read.csv("dados/ratings.csv",  encoding="UTF-8")

```

1 - Escolha uma trilogia (ou uma n-logia com n > 3) e avalie para qual dos episódios da trilogia há melhor avaliação e para qual há mais variação nas notas atribuídas ao filme.

Para a primeira parte, iremos escolher a trilogia Senhor dos Anéis.

```{r}

filmes.senhor.dos.aneis = filmes %>%
  filter(grepl('Lord of the Rings', title))

senhor.dos.aneis.ratings = ratings %>%
   filter(movieId %in% filmes.senhor.dos.aneis$movieId) 

head(filmes.senhor.dos.aneis)

```

Na seleção da trilogia, descobrimos um filme inesperado "The Lord of the Rings (1978)", filme americano de 1978, criado e realizado por Ralph Bakshi. A longa metragem é uma adaptação da primeira parte da trilogia "O Senhor dos Anéis"(1954-1955) e foi feita por Peter S. Beagle e Chris Conkling. O filme contém animação e cenas live-action utilizando a técnica rotoscoped para dar-lhe uma aparência mais consistente e real a toda a acção do filme. 


Iremos verificar a quantidade de avaliações que cada filme teve 
```{r}
senhor.dos.aneis.ratings.quant = senhor.dos.aneis.ratings %>%
group_by(movieId) %>%
summarise(quantidade = n())

head(senhor.dos.aneis.ratings.quant)

```

Como podemos verificar, o filme de 1978 possui 19 avaliações, e considerando que não faz parte da trilogia (2001 a 2003), vamos retirá-lo da análise.
E verificaremos a distribuição da amostra.

```{r}
senhor.dos.aneis.ratings = senhor.dos.aneis.ratings %>%
  filter(movieId != 2116)

ggplot(senhor.dos.aneis.ratings, aes(rating)) + 
  geom_bar() + 
  facet_wrap(~movieId, scales = c("free_y")) +
  ggtitle("Distribuição das avaliações da amostra do filme 'Senhor dos Anéis'")
```

A distribuição das avaliações dos usuários é  parecida, concentrando em sua maior parte à direita. E para uma maior representação, decidimos utilizar o intervalo de confiança feito com a média dos valores.


```{r}
#Lord of the Rings: The Fellowship of the Ring, The (2001)
experimento1 = sample_n(filter(senhor.dos.aneis.ratings, movieId == 4993), 1000, replace = TRUE)

bootstrap.media.senhor.dos.aneis1 = bootstrap(experimento1, mean(rating))
media.senhor.dos.aneis1 = CI.bca(bootstrap.media.senhor.dos.aneis1, probs = c(.025, .975))


# Lord of the Rings: The Two Towers, The (2002)
experimento2 = sample_n(filter(senhor.dos.aneis.ratings, movieId == 5952), 1000, replace = TRUE)

bootstrap.media.senhor.dos.aneis2 = bootstrap(experimento2, mean(rating))
media.senhor.dos.aneis2 = CI.bca(bootstrap.media.senhor.dos.aneis2, probs = c(.025, .975))


# Lord of the Rings: The Return of the King, The (2003)
experimento3 = sample_n(filter(senhor.dos.aneis.ratings, movieId == 7153), 1000, replace = TRUE)

bootstrap.media.senhor.dos.aneis3 = bootstrap(experimento3, mean(rating))
media.senhor.dos.aneis3 = CI.percentile(bootstrap.media.senhor.dos.aneis3, probs = c(.025, .975))


medias.senhor.dos.aneis = data.frame(
  rbind(
    c("SENHOR.DOS.ANEIS1", media.senhor.dos.aneis1),
    c("SENHOR.DOS.ANEIS2", media.senhor.dos.aneis2),
    c("SENHOR.DOS.ANEIS3", media.senhor.dos.aneis3)
  )
)

names(medias.senhor.dos.aneis) = c("titulo", "limite.inferior", "limite.superior")

medias.senhor.dos.aneis %>% 
  ggplot(aes(x = titulo, ymin = limite.inferior, ymax = limite.superior)) + 
  geom_errorbar(width = .2) +
    ggtitle("Intervalo de confiança da estimativa das médias das notas dos filmes de 'Senhor dos Anéis'")

```
Como conclusão à pergunta inicial 'Qual dos episódios da trilogia há melhor avaliação':
  Não podemos inferir com certeza qual o melhor filme da trilogia, visto que o intervalo de confiança da média das avaliações das amostras se sobrepõe. 
  
  
Para a segunda parte da pergunta (quanto a variação das notas), iremos determinar o intervalo de confiança para a variação nas notas atribuídas ao filme. 
  
  
```{r}
#Lord of the Rings: The Fellowship of the Ring, The (2001)

bootstrap.sd.senhor.dos.aneis1 = bootstrap(experimento1, sd(rating))
sd.senhor.dos.aneis1 = CI.bca(bootstrap.sd.senhor.dos.aneis1, probs = c(.025, .975))


# Lord of the Rings: The Two Towers, The (2002)

bootstrap.sd.senhor.dos.aneis2 = bootstrap(experimento2, sd(rating))
sd.senhor.dos.aneis2 = CI.bca(bootstrap.sd.senhor.dos.aneis2, probs = c(.025, .975))


# Lord of the Rings: The Return of the King, The (2003)

bootstrap.sd.senhor.dos.aneis3 = bootstrap(experimento3, sd(rating))
sd.senhor.dos.aneis3 = CI.percentile(bootstrap.sd.senhor.dos.aneis3, probs = c(.025, .975))


sd.senhor.dos.aneis <- data.frame(
  rbind(
    c("SENHOR.DOS.ANEIS1", sd.senhor.dos.aneis1),
    c("SENHOR.DOS.ANEIS2", sd.senhor.dos.aneis2),
    c("SENHOR.DOS.ANEIS3", sd.senhor.dos.aneis3)
  )
)

names(sd.senhor.dos.aneis) = c("titulo", "limite.inferior", "limite.superior")

sd.senhor.dos.aneis %>% 
  ggplot(aes(x = titulo, ymin = limite.inferior, ymax = limite.superior)) + 
  geom_errorbar(width = .2) +
    ggtitle("Intervalo de confiança da estimativa do desvio padrão das notas dos filmes de 'Senhor dos Anéis'")


```

Também não é possível inferir sobre qual filme possui maior variabilidade.
  

2- Normalmente os filmes têm vários gêneros. Existe uma relação entre em quantos gêneros os filmes se encaixam e a avaliação que os filmes recebem? Mais especificamente: se consideramos a os filmes com 1, 2, 3 ... gêneros, existe alguma quantidade de gêneros num mesmo filme que em geral recebe avaliações melhores? Caso exista, estime a diferença entre essa combinação e filmes com apenas um gênero. (Repare que você terá que escolher que medida você comparará: média, mediana, etc.)

  
```{r}
generos = read.csv("dados/movie-genre.csv",  encoding="UTF-8")

```

Por ser uma quantidade maior de dados e a provável assimetria dos dados de avaliações, iremos utilizar a mediana como forma de comparação. 

```{r}
mediana.generos = data.frame(movieId=numeric(0), n=numeric(0), mediana=numeric(0))

#generos = spread(generos, key = genre, value = genre)

quantidade.genero.filme = generos %>%
  group_by(title) %>%
  summarise(quantidade.generos = n())

quantidade.genero.filme = merge(quantidade.genero.filme, filmes, by=c("title","title")) 

quantidade.genero.filme = quantidade.genero.filme %>%
  select(movieId, title, quantidade.generos) %>%
  arrange(quantidade.generos)

# FALTA:
# AGRUPAR POR QUANTIDADE DE GENEROS
# FAZER A DISTRIBUIÇÃO AMOSTRAL BASEADA NA MEDIANA (PROVAVEL ASSIMETRIA DAS AVALIAÇÕES)
# VERIFICAR RESULTADO


```


